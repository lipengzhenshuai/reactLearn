<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    .editable-box {
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 100px;
    }

    .editable-box .tag {
      background-color: #d7e7ff;
      padding: 0 5px;
      border-radius: 5px;
      display: inline-block;
      cursor: pointer;
    }
    .editable-box .tag:empty:before {
      content: attr(data-placeholder); /* ä½¿ç”¨ä¼ªå…ƒç´ æ˜¾ç¤ºplaceholder */
      color: #999;
    }

    .content-box .tag {
        display: inline-block;
        /* padding: 8px; */
        border: 1px solid #ccc;
        border-radius: 4px;
      }
    .content-box .tag span {
      white-space: pre;
    }
    .content-box .tag {
      background-color: #d7e7ff;
      padding: 0 5px;
      border-radius: 5px;
      display: inline-block;
      cursor: pointer;
    }
    .content-box .tag:empty:before {
      content: attr(data-placeholder); /* ä½¿ç”¨ä¼ªå…ƒç´ æ˜¾ç¤ºplaceholder */
      color: #999;
    }
  </style>
</head>

<body>
  <img src="./img/image.png" style="width:100%"/>
  <div class="editable-box">å¸®æˆ‘å†™ä¸€ä¸ªæ•…äº‹ï¼Œç±»å‹ä¸º<span class="tag" contenteditable="true">[ä¾‹å¦‚ï¼šç§‘å¹»]</span>&nbsp;ï¼Œå†™ä½œé£æ ¼æ¨¡ä»¿<span class="tag" contenteditable="true">[ä¾‹å¦‚ï¼šæ‘ä¸Šæ˜¥æ ‘]</span>&nbsp;ï¼Œå­—æ•°<span class="tag" contenteditable="true">[è¾“å…¥æ•°å­—]</span>&nbsp;å·¦å³ã€‚å†™ä½œæç¤ºï¼šå±‚å±‚é€’è¿›ã€å±‚æ¬¡æ¸…æ™°ã€é€»è¾‘ä¸¥å¯†ã€æ–‡é‡‡æ–ç„¶ã€è¡¨è¿°ç”ŸåŠ¨å½¢è±¡ã€<span class="tag" contenteditable="true">[å…¶ä»–è¡¥å……è¦æ±‚]</span>&nbsp;ã€‚</div>
  <div id="editable" contenteditable="true" class="editable-box">å¸®æˆ‘å†™ä¸€ä¸ªæ•…äº‹ï¼Œç±»å‹ä¸º<span class="tag" contenteditable="true">[ä¾‹å¦‚ï¼šç§‘å¹»]</span>&nbsp;ï¼Œå†™ä½œé£æ ¼æ¨¡ä»¿<span class="tag" contenteditable="true">[ä¾‹å¦‚ï¼šæ‘ä¸Šæ˜¥æ ‘]</span>&nbsp;ï¼Œå­—æ•°<span class="tag" contenteditable="true">[è¾“å…¥æ•°å­—]</span>&nbsp;å·¦å³ã€‚å†™ä½œæç¤ºï¼šå±‚å±‚é€’è¿›ã€å±‚æ¬¡æ¸…æ™°ã€é€»è¾‘ä¸¥å¯†ã€æ–‡é‡‡æ–ç„¶ã€è¡¨è¿°ç”ŸåŠ¨å½¢è±¡ã€<span class="tag" contenteditable="true">[å…¶ä»–è¡¥å……è¦æ±‚]</span>&nbsp;ã€‚</div>
  </div>
  <button id="insertTag">æ’å…¥æ ‡è®°</button><br />
  <button id="validateData">æ ¡éªŒå†…å®¹</button><br />
  <button id="userUse">ç”Ÿæˆæ’å…¥</button><br />
  <div id="container" class="content-box"></div>
  <button id="getInput">è·å–å†…å®¹</button><br />
  <div id="result"></div>
  <script>
    document.getElementById("insertTag").addEventListener("click", function () {
      const editableDiv = document.getElementById("editable");

      // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°
      const tag = document.createElement("span");
      tag.className = "tag";
      tag.contentEditable = "true";  // å…è®¸ç¼–è¾‘æ ‡ç­¾å†…çš„æ–‡å­—
      tag.textContent = "[è¾“å…¥æ ‡è®°]";  // å…è®¸ç¼–è¾‘æ ‡ç­¾å†…çš„æ–‡å­—
      tag.setAttribute("data-placeholder", "[è¾“å…¥æ ‡è®°]");

      // æ’å…¥æ ‡è®°åˆ°å½“å‰å…‰æ ‡ä½ç½®
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        
        // æ£€æŸ¥å…‰æ ‡æ˜¯å¦åœ¨spanæ ‡ç­¾å†…éƒ¨
        const isInsideSpan = (node) => {
          while (node && node !== editableDiv) {
            if (node.nodeName === 'SPAN') return true;
            node = node.parentNode;
          }
          return false;
        };

        if (isInsideSpan(range.commonAncestorContainer)) {
          alert('æ— æ³•åœ¨æ ‡è®°å†…æ’å…¥æ ‡è®°');
          return;
        }

        // åˆ é™¤é€‰ä¸­çš„å†…å®¹
        range.deleteContents();
        
        // æ’å…¥æ–°æ ‡ç­¾
        range.insertNode(tag);

        // åˆ›å»ºä¸€ä¸ªç©ºçš„æ–‡æœ¬èŠ‚ç‚¹æ”¾åœ¨æ ‡ç­¾åé¢ï¼Œç¡®ä¿å…‰æ ‡ç§»åˆ°æ ‡ç­¾å¤–
        const space = document.createTextNode("\u00A0");  // ä½¿ç”¨ç©ºæ ¼å­—ç¬¦
        tag.after(space);

        // å°†å…‰æ ‡ç§»åˆ°æ ‡ç­¾åçš„ç©ºç™½å¤„
        range.setStartAfter(space);
        range.setEndAfter(space);
        selection.removeAllRanges();
        selection.addRange(range);
      }
    });



    document.getElementById("editable").addEventListener("keydown", function (event) {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;

      const range = selection.getRangeAt(0);
      const currentNode = range.startContainer;

      // å¦‚æœæŒ‰ä¸‹çš„æ˜¯ Backspace é”®
      if (event.key === "Backspace") {
        const previousNode = currentNode.previousSibling;
        console.log('lipeng-ğŸš€- ~ previousNode:', previousNode)
        console.log('lipeng-ğŸš€- ~ range.startOffset:', range.startOffset)

        // å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯è‡ªå®šä¹‰æ ‡ç­¾å¹¶ä¸”å…‰æ ‡åœ¨æ ‡ç­¾å‰
        if (previousNode && previousNode.classList && previousNode.classList.contains("tag")) {
          if (range.startOffset === 1) {
            event.preventDefault();  // é˜»æ­¢é»˜è®¤åˆ é™¤æ“ä½œ
            previousNode.remove();    // åˆ é™¤æ•´ä¸ªæ ‡ç­¾
          }
        }
      }
    });

    document.getElementById("validateData").addEventListener("click", (event) => {
      const spans = document.querySelectorAll('div.editable-box span');
      const regex = /^\[[^\]]*\]$/;

      // æ­£ç¡®çš„æƒ…å†µï¼š
      // [ä¾‹å¦‚ï¼šã€ã€‘ã€‚ã€ã€‘æ•°å­—] ï¼Œ [2,,2]
      // ä¸æ­£ç¡®çš„æƒ…å†µ: qqwqw], [sdfsdf,  [sdfsdfsd]dfsdf
      spans.forEach(span => {
          if (!regex.test(span.textContent)) {
              console.log(`Invalid content: ${span.textContent}`);
              setTimeout(() => {alert(`${span.textContent} æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥`)})
          } else {
              console.log(`Valid content: ${span.textContent}`);
          }
      });
    });

    const parse = (htmlContent) => {
      // æ­£åˆ™è¡¨è¾¾å¼
      const regex = /<span([^>]*)>(.*?)<\/span>/g;
      // æ›¿æ¢å‡½æ•°
      htmlContent = htmlContent.replace(regex, (match, p1, p2) => {
          const placeholderText = p2.replace(/\[|\]/g, ''); // å»æ‰æ–¹æ‹¬å·
          return `<span${p1} data-placeholder="${placeholderText}"></span>`;
      });
      return htmlContent;
    }

    document.getElementById("userUse").addEventListener("click", () => {
      const editableDiv = document.getElementById("editable");
      const content = editableDiv.innerHTML;
      document.getElementById('container').innerHTML = parse(content);
      // 
    });

    document.getElementById("getInput").addEventListener("click", () => {
      const result = document.getElementById("container").textContent;
      document.getElementById("result").innerHTML = result;
    });

  </script>
</body>

</html>
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editable Input</title>
    <style>
      .editable-box {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 100px;
      }

      .non-editable {
        margin: 2px;
        color: blue;
        background-color: #e0eaff; /* æ·¡è“è‰²èƒŒæ™¯ */
      }

      .custom-span {
        color: blue;
        font-weight: bold;
      }
      /* è®©é€‰ä¸­çš„æ¡†å¤±å»å¤–å±‚è“è‰²å±‚ */
      /* .custom-span:focus-visible {
        outline: none;
      } */
    </style>
  </head>
  <body>
    <div>
      <div id="editable" contenteditable="true" class="editable-box"></div>
      <!-- <div id="editable" contenteditable="true" class="editable-box">æ°´ç”µè´¹æ°´ç”µè´¹æ°´ç”µè´¹æ°´ç”µè´¹æ°´ç”µè´¹æ°´ç”µè´¹<span class="non-editable" contenteditable="false"><span>#</span><span class="custom-span" contenteditable="true">111</span><span>#</span></span>ç¬¬ä¸‰æ–¹ç¼©æ”¾æ°´ç”µè´¹é¥­æ°´ç”µè´¹<span class="non-editable" contenteditable="false"><span>#</span><span class="custom-span" contenteditable="true">111</span><span>#</span></span><span class="non-editable" contenteditable="false"><span>#</span><span class="custom-span" contenteditable="true">111</span><span>#</span></span>ç¬¬ä¸‰æ–¹æ°´ç”µè´¹æ°´ç”µè´¹æ°´ç”µè´¹ç¬¬ä¸‰æ–¹<span class="non-editable" contenteditable="false"><span>#</span><span class="custom-span" contenteditable="true">111</span><span>#</span></span>æ°´ç”µè´¹</div> -->
      <button id="insertSpan">Insert Span</button>
      <div id="parseContent"></div>
      <button id="dddd">ç”Ÿæˆæ–°å¢é€»è¾‘</button>
    </div>

    <script>
      const gene1 = () => {
        // åˆ›å»ºçˆ¶å…ƒç´  (ä¸å¯ç¼–è¾‘)
        const nonEditableSpan = document.createElement("span");
        nonEditableSpan.className = "non-editable";
        nonEditableSpan.setAttribute("contenteditable", "plaintext-only");

        // åˆ›å»ºå­å…ƒç´  (å¯ç¼–è¾‘)
        const editableSpan = document.createElement("span");
        editableSpan.className = "custom-span";
        editableSpan.setAttribute("contenteditable", "true");
        editableSpan.textContent = "#1111#";

        // å°†å­å…ƒç´ æ·»åŠ åˆ°çˆ¶å…ƒç´ ä¸­
        nonEditableSpan.appendChild(editableSpan);
        return nonEditableSpan;
      };

      const gene2 = () => {
        // åˆ›å»ºçˆ¶å…ƒç´  (ä¸å¯ç¼–è¾‘)
        const nonEditableSpan = document.createElement("span");
        nonEditableSpan.className = "non-editable";
        nonEditableSpan.setAttribute("contenteditable", "false");

        // åˆ›å»ºåŒ…è£¹#å·çš„spanå…ƒç´ 
        const hashStart = document.createElement("span");
        hashStart.textContent = "#";

        // åˆ›å»ºåŒ…å«æ•°å­—çš„spanå…ƒç´ 
        const numberSpan = document.createElement("span");
        numberSpan.className = "custom-span";
        numberSpan.setAttribute("contenteditable", "true");
        numberSpan.textContent = "111";

        // åˆ›å»ºç»“æŸ#å·çš„spanå…ƒç´ 
        const hashEnd = document.createElement("span");
        hashEnd.textContent = "#";

        // å°†æ‰€æœ‰å­å…ƒç´ æ·»åŠ åˆ°çˆ¶å…ƒç´ ä¸­
        nonEditableSpan.appendChild(hashStart);
        nonEditableSpan.appendChild(numberSpan);
        nonEditableSpan.appendChild(hashEnd);

        return nonEditableSpan;
      };

      document
        .getElementById("insertSpan")
        .addEventListener("click", function () {
          const editableDiv = document.getElementById("editable");
          const span = gene2(); // å‡è®¾ gene1() è¿”å›çš„æ˜¯ä½ æƒ³æ’å…¥çš„ span å…ƒç´ 
          // è·å–å½“å‰çš„é€‰åŒºå’ŒèŒƒå›´
          const selection = window.getSelection();
          if (!selection.rangeCount) return; // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„é€‰åŒºï¼Œåˆ™é€€å‡ºå‡½æ•°
          const range = selection.getRangeAt(0);
          // åˆ é™¤ä»»ä½•é€‰ä¸­çš„å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
          range.deleteContents();
          // æ’å…¥æ–°çš„ span å…ƒç´ 
          range.insertNode(span);
          // // åˆ›å»ºä¸€ä¸ªç©ºçš„æ–‡æœ¬èŠ‚ç‚¹å¹¶æ’å…¥åˆ° span åé¢
          // const afterSpan = document.createTextNode("");
          // span.parentNode.insertBefore(afterSpan, span.nextSibling);
          // æ›´æ–°èŒƒå›´ä»¥å°†å…‰æ ‡æ”¾ç½®åœ¨ç©ºçš„æ–‡æœ¬èŠ‚ç‚¹åé¢
          range.setStartAfter(span);
          range.collapse(true);
          // æ¸…é™¤æ‰€æœ‰çš„é€‰åŒºï¼Œç„¶åæ·»åŠ æ–°çš„èŒƒå›´
          selection.removeAllRanges();
          selection.addRange(range);
        });

      // document
      //   .getElementById("editable")
      //   .addEventListener("keydown", function (event) {
      //     if (event.key === "Backspace" || event.key === "Delete") {
      //       const selection = window.getSelection();
      //       if (!selection.rangeCount) return;

      //       if (selection.rangeCount > 0) {
      //         const range = selection.getRangeAt(0);
      //         console.log("ğŸš€ ~ document.getElementById ~ range:", range);
      //         console.log("ğŸš€ ~ document.getElementById ~ range.startOffset:", range.startOffset);
      //         console.log("ğŸš€ ~ range.startContainer.previousSibling:", range.startContainer.previousSibling)
      //         if (
      //           range.startOffset === 0 &&
      //           range.startContainer.previousSibling
      //         ) {
      //           const previousNode = range.startContainer.previousSibling;
      //           if (
      //             previousNode.nodeType === Node.ELEMENT_NODE &&
      //             previousNode.classList.contains("non-editable")
      //           ) {
      //             event.preventDefault(); // Prevent the default backspace action
      //             previousNode.remove(); // Remove the non-editable span
      //           }
      //         }
      //       }
      //     }
      //   });

  //       document
  // .getElementById("editable")
  // .addEventListener("keydown", function (event) {
  //   if (event.key === "Backspace" || event.key === "Delete") {
  //     const selection = window.getSelection();
  //     if (!selection.rangeCount) return;

  //     const range = selection.getRangeAt(0);
  //     console.log("ğŸš€ ~ document.getElementById ~ range:", range);
  //     console.log("ğŸš€ ~ document.getElementById ~ range.startOffset:", range.startOffset);
  //     console.log("ğŸš€ ~ range.startContainer.previousSibling:", range.startContainer.previousSibling)

  //     // å¦‚æœèµ·å§‹åç§»é‡ä¸º0ï¼Œä¸”æœ‰å‰ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
  //     if (range.startOffset === 0 && range.startContainer.previousSibling) {
  //       let previousNode = range.startContainer.previousSibling;

  //       // éå†æ‰¾åˆ°ç¬¬ä¸€ä¸ªéæ–‡æœ¬èŠ‚ç‚¹ï¼ˆå³å…ƒç´ èŠ‚ç‚¹ï¼‰
  //       while (previousNode && previousNode.nodeType !== Node.ELEMENT_NODE) {
  //         previousNode = previousNode.previousSibling;
  //       }

  //       // æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°äº†å…·æœ‰.non-editableç±»çš„å…ƒç´ èŠ‚ç‚¹
  //       if (
  //         previousNode &&
  //         previousNode.nodeType === Node.ELEMENT_NODE &&
  //         previousNode.classList.contains("non-editable")
  //       ) {
  //         event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„é€€æ ¼æ“ä½œ
  //         previousNode.remove(); // ç§»é™¤ä¸å¯ç¼–è¾‘çš„spanå…ƒç´ 
  //       }
  //     }
  //   }
  // });
  document.getElementById("editable").addEventListener("keydown", function (event) {
  if (event.key === "Backspace" || event.key === "Delete") {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    let range = selection.getRangeAt(0);
    let startContainer = range.startContainer;
    let startOffset = range.startOffset;

    // æ£€æŸ¥æ˜¯å¦åœ¨æ–‡æœ¬èŠ‚ç‚¹å†…
    if (startContainer.nodeType === Node.TEXT_NODE) {
      // Backspace é”®ï¼šå¦‚æœå…‰æ ‡åœ¨æ–‡æœ¬èŠ‚ç‚¹çš„èµ·å§‹ä½ç½®
      if (event.key === "Backspace" && startOffset === 0) {
        let previousNode = startContainer.previousSibling;

        while (previousNode && previousNode.nodeType !== Node.ELEMENT_NODE) {
          previousNode = previousNode.previousSibling;
        }

        if (
          previousNode &&
          previousNode.nodeType === Node.ELEMENT_NODE &&
          previousNode.classList.contains("non-editable")
        ) {
          event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„é€€æ ¼æ“ä½œ
          previousNode.remove();

          // æ›´æ–°é€‰æ‹©èŒƒå›´ä»¥åæ˜ æ–°çš„DOMçŠ¶æ€
          range.setStart(startContainer, 0);
          selection.removeAllRanges();
          selection.addRange(range);

          return; // ç»“æŸå‡½æ•°æ‰§è¡Œï¼Œä¸ç»§ç»­å¤„ç†
        }
      }

      // Delete é”®ï¼šå¦‚æœå…‰æ ‡åœ¨æ–‡æœ¬èŠ‚ç‚¹çš„æœ«å°¾ä½ç½®
      if (event.key === "Delete" && startOffset === startContainer.length) {
        let nextNode = startContainer.nextSibling;

        while (nextNode && nextNode.nodeType !== Node.ELEMENT_NODE) {
          nextNode = nextNode.nextSibling;
        }

        if (
          nextNode &&
          nextNode.nodeType === Node.ELEMENT_NODE &&
          nextNode.classList.contains("non-editable")
        ) {
          event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„åˆ é™¤æ“ä½œ
          nextNode.remove();

          // æ›´æ–°é€‰æ‹©èŒƒå›´ä»¥åæ˜ æ–°çš„DOMçŠ¶æ€
          range.setEnd(startContainer, startContainer.length);
          selection.removeAllRanges();
          selection.addRange(range);

          return; // ç»“æŸå‡½æ•°æ‰§è¡Œï¼Œä¸ç»§ç»­å¤„ç†
        }
      }
    } else if (startContainer.nodeType === Node.ELEMENT_NODE) {
      // å¦‚æœå…‰æ ‡ç›´æ¥ä½äºå…ƒç´ èŠ‚ç‚¹ä¸­ï¼Œä¾‹å¦‚ <br> æˆ–è€…ç©ºçš„ <div>
      if (event.key === "Backspace" && startOffset > 0) {
        let previousNode = startContainer.childNodes[startOffset - 1];

        if (
          previousNode &&
          previousNode.nodeType === Node.ELEMENT_NODE &&
          previousNode.classList.contains("non-editable")
        ) {
          event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„é€€æ ¼æ“ä½œ
          previousNode.remove();

          // æ›´æ–°é€‰æ‹©èŒƒå›´ä»¥åæ˜ æ–°çš„DOMçŠ¶æ€
          range.setStart(startContainer, startOffset - 1);
          selection.removeAllRanges();
          selection.addRange(range);

          return; // ç»“æŸå‡½æ•°æ‰§è¡Œï¼Œä¸ç»§ç»­å¤„ç†
        }
      }

      if (event.key === "Delete" && startOffset < startContainer.childNodes.length) {
        let nextNode = startContainer.childNodes[startOffset];

        if (
          nextNode &&
          nextNode.nodeType === Node.ELEMENT_NODE &&
          nextNode.classList.contains("non-editable")
        ) {
          event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„åˆ é™¤æ“ä½œ
          nextNode.remove();

          // æ›´æ–°é€‰æ‹©èŒƒå›´ä»¥åæ˜ æ–°çš„DOMçŠ¶æ€
          range.setStart(startContainer, startOffset);
          selection.removeAllRanges();
          selection.addRange(range);

          return; // ç»“æŸå‡½æ•°æ‰§è¡Œï¼Œä¸ç»§ç»­å¤„ç†
        }
      }
    }
  }
});

      // TODO: ç›®å‰åˆ é™¤æœ‰é—®é¢˜
      // document
      //   .getElementById("editable")
      //   .addEventListener("keydown", function (event) {
      //     // æŒ‰ä¸‹ Backspace é”®æ—¶çš„é€»è¾‘
      //     if (event.key === "Backspace") {
      //       const selection = window.getSelection();
      //       console.log("ğŸš€ ~ selection:", selection);
      //       if (!selection.rangeCount) return;

      //       const range = selection.getRangeAt(0);
      //       console.log("ğŸš€ ~ range:", range)
      //       const currentNode = range.startContainer;
      //       const startOffset = range.startOffset;
      //       console.log("ğŸš€ ~ range.startOffset:", range.startOffset)
      //       // å¦‚æœå…‰æ ‡åœ¨æ–‡æœ¬èŠ‚ç‚¹çš„å¼€å¤´
      //       if (startOffset === 0 && currentNode.previousElementSibling) {
      //         let previousNode = currentNode.previousElementSibling;

      //         if (
      //           previousNode &&
      //           previousNode.nodeType === Node.ELEMENT_NODE &&
      //           previousNode.classList.contains("non-editable")
      //         ) {
      //           event.preventDefault(); // é˜»æ­¢é»˜è®¤åˆ é™¤æ“ä½œ
      //           previousNode.remove(); // åˆ é™¤æ•´ä¸ªéç¼–è¾‘çš„span
      //         }
      //       }
      //     }
      //   });

      // document
      //   .getElementById("editable")
      //   .addEventListener("keydown", function (event) {
      //     if (event.key === "Backspace") {
      //       const selection = window.getSelection();
      //       if (!selection.rangeCount) return;

      //       const range = selection.getRangeAt(0);
      //       const currentNode = range.startContainer;
      //       const startOffset = range.startOffset;

      //       // æ£€æŸ¥å…‰æ ‡æ˜¯å¦åœ¨æ–‡æœ¬èŠ‚ç‚¹ä¸­
      //       if (currentNode.nodeType === Node.TEXT_NODE) {
      //         const parentNode = currentNode.parentNode;
      //         let previousNode = currentNode.previousSibling;

      //         // å¤„ç†éæ–‡æœ¬èŠ‚ç‚¹æƒ…å†µï¼Œè·å–çˆ¶çº§å…„å¼ŸèŠ‚ç‚¹
      //         if (!previousNode) {
      //           previousNode = parentNode.previousSibling;
      //         }

      //         // å¦‚æœå‰ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹æ˜¯ non-editable çš„ spanï¼Œä¸”å…‰æ ‡åœ¨æ–‡æœ¬çš„å¼€å¤´æˆ–åœ¨ span å‰
      //         if (
      //           previousNode &&
      //           previousNode.nodeType === Node.ELEMENT_NODE &&
      //           previousNode.classList.contains("non-editable") &&
      //           startOffset === 0
      //         ) {
      //           event.preventDefault(); // é˜»æ­¢é»˜è®¤åˆ é™¤æ“ä½œ
      //           previousNode.remove(); // åˆ é™¤ non-editable span
      //         }
      //       }
      //     }
      //   });

      //       document.getElementById("editable").addEventListener("keydown", function (event) {
      //   if (event.key === "Backspace") {
      //     const selection = window.getSelection();
      //     if (!selection.rangeCount) return;

      //     const range = selection.getRangeAt(0);
      //     const currentNode = range.startContainer;

      //     // å¦‚æœå…‰æ ‡åœ¨æ–‡æœ¬èŠ‚ç‚¹å¼€å¤´ï¼Œæ£€æŸ¥å…¶å‰é¢å…„å¼ŸèŠ‚ç‚¹
      //     if (currentNode.nodeType === Node.TEXT_NODE && range.startOffset === 0) {
      //       let previousNode = currentNode.previousSibling;

      //       // è·å–çˆ¶èŠ‚ç‚¹çš„å‰ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
      //       if (!previousNode) {
      //         previousNode = currentNode.parentNode.previousSibling;
      //       }

      //       // åªåˆ é™¤éç¼–è¾‘çš„ span å…ƒç´ 
      //       if (previousNode &&
      //           previousNode.nodeType === Node.ELEMENT_NODE &&
      //           previousNode.classList.contains("non-editable")) {
      //         event.preventDefault(); // é˜»æ­¢é»˜è®¤åˆ é™¤æ“ä½œ
      //         previousNode.remove(); // åˆ é™¤ non-editable span
      //       }
      //     }
      //     // å¦‚æœå…‰æ ‡åœ¨å…ƒç´ èŠ‚ç‚¹å†…ï¼Œæ£€æŸ¥å…‰æ ‡å‰çš„å…„å¼ŸèŠ‚ç‚¹
      //     else if (currentNode.nodeType === Node.ELEMENT_NODE) {
      //       let previousNode = currentNode.previousSibling;

      //       if (previousNode &&
      //           previousNode.nodeType === Node.ELEMENT_NODE &&
      //           previousNode.classList.contains("non-editable")) {
      //         event.preventDefault(); // é˜»æ­¢é»˜è®¤åˆ é™¤æ“ä½œ
      //         previousNode.remove(); // åˆ é™¤ non-editable span
      //       }
      //     }
      //   }
      // });

      // document
      //   .getElementById("editable")
      //   .addEventListener("keydown", function (event) {
      //     if (event.key === "Backspace") {
      //       const selection = window.getSelection();
      //       if (!selection.rangeCount) return;

      //       const range = selection.getRangeAt(0);
      //       const currentNode = range.startContainer;
      //       let previousNode = null;

      //       // å¦‚æœå…‰æ ‡åœ¨æ–‡æœ¬èŠ‚ç‚¹å¼€å¤´ï¼Œæ£€æŸ¥å…¶å‰é¢å…„å¼ŸèŠ‚ç‚¹
      //       if (
      //         currentNode.nodeType === Node.TEXT_NODE &&
      //         range.startOffset === 0
      //       ) {
      //         previousNode = currentNode.previousSibling;

      //         // è·å–çˆ¶èŠ‚ç‚¹çš„å‰ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
      //         if (!previousNode) {
      //           previousNode = currentNode.parentNode.previousSibling;
      //         }
      //       }
      //       // å¦‚æœå…‰æ ‡åœ¨å…ƒç´ èŠ‚ç‚¹å†…ï¼Œæ£€æŸ¥å…‰æ ‡å‰çš„å…„å¼ŸèŠ‚ç‚¹
      //       else if (currentNode.nodeType === Node.ELEMENT_NODE) {
      //         previousNode = currentNode.childNodes[range.startOffset - 1];
      //       }

      //       // æ£€æŸ¥å¹¶åˆ é™¤ non-editable span å…ƒç´ 
      //       if (
      //         previousNode &&
      //         previousNode.nodeType === Node.ELEMENT_NODE &&
      //         previousNode.classList.contains("non-editable")
      //       ) {
      //         event.preventDefault(); // é˜»æ­¢é»˜è®¤åˆ é™¤æ“ä½œ
      //         previousNode.remove(); // åˆ é™¤ non-editable span

      //         // æ›´æ–°é€‰åŒºèŒƒå›´
      //         const newRange = document.createRange();
      //         newRange.setStart(currentNode, 0);
      //         newRange.collapse(true);

      //         selection.removeAllRanges();
      //         selection.addRange(newRange);
      //       }
      //     }
      //   });

      // document
      //   .getElementById("editable")
      //   .addEventListener("keydown", function (e) {
      //     if (e.key === "Backspace") {
      //       const sel = window.getSelection();
      //       if (!sel.rangeCount) return;

      //       const range = sel.getRangeAt(0);
      //       const startContainer = range.startContainer;
      //       const startOffset = range.startOffset;

      //       // æ£€æŸ¥å…‰æ ‡æ˜¯å¦ä½äºæ–‡æœ¬èŠ‚ç‚¹å¼€å¤´ï¼Œä¸”è¯¥æ–‡æœ¬èŠ‚ç‚¹å‰é¢æœ‰ä¸€ä¸ªspanå…ƒç´ 
      //       if (
      //         startContainer.nodeType === Node.TEXT_NODE &&
      //         startOffset === 0
      //       ) {
      //         const prevNode = startContainer.previousSibling;
      //         if (
      //           prevNode &&
      //           prevNode.nodeType === Node.ELEMENT_NODE &&
      //           prevNode.matches(".special-span")
      //         ) {
      //           e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„åˆ é™¤æ“ä½œ

      //           // åˆ é™¤spanå…ƒç´ 
      //           prevNode.remove();

      //           // å¦‚æœåˆ é™¤åå…‰æ ‡ä½ç½®æ˜¯ç©ºçš„ï¼Œå°†å…‰æ ‡ç§»åŠ¨åˆ°å‰ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      //           if (!startContainer.textContent.trim()) {
      //             const prevTextNode = prevNode.previousSibling;
      //             if (
      //               prevTextNode &&
      //               prevTextNode.nodeType === Node.TEXT_NODE
      //             ) {
      //               range.setStart(
      //                 prevTextNode,
      //                 prevTextNode.textContent.length
      //               );
      //               range.setEnd(prevTextNode, prevTextNode.textContent.length);
      //             } else {
      //               // å¦‚æœæ²¡æœ‰å‰ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ï¼Œåˆ™å°è¯•å°†å…‰æ ‡æ”¾åœ¨å½“å‰èŠ‚ç‚¹çš„æœ«å°¾ï¼ˆå¯èƒ½æ˜¯æ–°çš„ç©ºç™½æ–‡æœ¬èŠ‚ç‚¹ï¼‰
      //               range.setStart(
      //                 startContainer,
      //                 startContainer.textContent.length
      //               );
      //               range.setEnd(
      //                 startContainer,
      //                 startContainer.textContent.length
      //               );
      //             }
      //           }

      //           // æ›´æ–°é€‰åŒº
      //           sel.removeAllRanges();
      //           sel.addRange(range);
      //         }
      //       }

      //       // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„é€»è¾‘æ¥å¤„ç†å…¶ä»–æƒ…å†µï¼Œæ¯”å¦‚å…‰æ ‡åœ¨spanå†…éƒ¨çš„æƒ…å†µ
      //     }
      //   });

      document
        .getElementById("dddd")
        .addEventListener("click", function (event) {
          const result = document.getElementById("editable").innerHTML;
          document.getElementById("parseContent").innerHTML =
            replaceSpansWithInputs(result);
        });

      const replaceSpansWithInputs = (html) => {
        return html.replace(
          /<span class="custom-span" contenteditable="true">#(\d+)#<\/span>/g,
          (match, p1) => {
            return `<input type="text" placeholder="${p1}"/>`;
          }
        );
      };
    </script>
  </body>
</html>
